<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1" />
    <title>方球</title>
    <link  rel="icon" type="image/x-icon" href="./images/favicon.ico">
    <link rel="stylesheet" href="css/base.css"/>
    <link rel="stylesheet" href="css/style.css"/>
    <style>
        .create_img{display: inline-block;}
        .publish_upimg .img{font-size: 0; width: 50%; height: 142px; float: left;  text-align: center; margin-bottom: 10px;}
        .publish_upimg .imgcenter{position: relative; width: 142px; height: 142px; margin:0 auto; border-radius: 4px; overflow: hidden;}
        .publish_upimg .imgcenter img{width: 100%; height: 100%; display: block;}
        .publish_upimg .delShadow{position: absolute; left:0; top:0; display: none; width: 100%;  height: 142px;  text-align: center; background: rgba(0,0,0,0.5);}
        .publish_upimg .delShadow .del{display: inline-block; width: 26px; height: 26px; margin-top:58px; background: url("./images/del.png") no-repeat center center; background-size:100% 100%; }
    </style>
</head>
<body>
<div id="header" class="bb518">
    <div class="main pr">
        <a class="back" href="javascript:history.back(-1);"></a>
        发布动态
    </div>
</div>
<div class="create_box">
    <div class="create_txt main">
        <div class="center">
            <textarea name="" id="data_circle_txt" placeholder="输入正文"></textarea>
        </div>
    </div>
    <div class="publish_upimg main" id="imgboxid">
        <!--<div class="img"><img src="images/photo.jpg" alt=""/></div>-->
        <!--<div class="img"><img src="images/photo.jpg" alt=""/></div>-->
        <!--<div class="img"><img src="images/photo.jpg" alt=""/></div>-->
        <div class="img upbtn"><div class="create_img">+</div></div>
    </div>
    <form id="uploadForm" enctype="multipart/form-data">
        <input id="file" type="file" onchange="xmTanUploadImg(this)"  multiple="multiple"  accept="image/*;capture=camera" name="file" style="display: none;"/>
    </form>
    <div class="create_btn main mt20"><input id="data_submit" type="button" value="发布"/></div>
    <div class="create_ts main mt10">方球倡导健康文明的网络环境，愿能一起为区块链及虚拟币行业的健康发展贡献一份力！请勿传播淫秽、色情、低俗、暴力、谣言等信息，一经发现，立即封号！</div>
</div>
<script src="js/jquery.min.js"></script>
<script src="js/js.js"></script>
<script>
    var circle_id = GetHrefVal("circleId");
    /**
     * html5实现图片预览+上传功能
     *
     * **/
        //图片预览
    $(".create_img").click(function(){
        $("#file").click();
    });

    function xmTanUploadImg(obj){

        var file = obj.value;
        if(!/.(gif|jpg|jpeg|png|GIF|JPG|PNG)$/.test(file)){
            wrongTs("上传图片只能是图片格式");
            return false;
        }else{
            //返回Byte(B),保留小数点后两位
            if(((obj.files[0].size).toFixed(2))>=(20*1024*1024)){
                wrongTs("上传图片不能超过 20M");
                return false;
            }else{
                // 本地显示处理
                var flen=obj.files.length;
                if(flen <=3){
//                    for(var i = 0;i < flen;i++){
//                        var file=obj.files[i];
//                        var reader = new FileReader();
//                        console.log(i);
//                        reader.onload = function (e) {
//                            // 这里是显示本地图片的方法；实际开发应该是图片上传成功才显示
//                            $(".publish_upimg").prepend("<div class='img upimg' data-photoid='a0000a"+i+"'><div class='imgcenter'><div class='delShadow'><i class='del'></i></div><img src='"+e.target.result+"' alt=''/></div></div>");
//                            upimglen();
//                        };
//
//                        reader.readAsDataURL(file);
//                    }
                    // 给服务器提交数据
                    upload();
                }else{
                    wrongTs("只能上传3张图片");
                }
            }

        }
    }

    //    上传功能：把图片上传给接口功能
    function upload(){
        var formData = new FormData();
        var file = document.getElementById("file");
        var fileList = file.files;
        for(var i=0;i < fileList.length;i++){
            formData.append("file",fileList[i]);
            $.ajax({
                headers: {
                    Accept: "application/json; charset=utf-8",
                    Authorization: "" + userToken
                },
                type: 'post',
                url: PORT_CONNECT+"/api/v1/upload_photo",
                data: formData,
                cache: false,
                processData: false,
                contentType: false,
                dataType:"json",
                success:function(data){
                    console.log(data);
                    var photoId = data["data"].id;
                    $(".publish_upimg").prepend("<div class='img upimg' data-photoid='"+photoId+"'><div class='imgcenter'><div class='delShadow'><i class='del'></i></div><img src='"+IMG_SRC+data["data"].url+"' alt=''/></div></div>");
                    upimglen();
                },
                error:function (e) {
                    console.log("上传失败");
                }
            })
        }
    }


     // 删除图片
    delShow();
    function delShow(){
        $(".publish_upimg").on("click",".imgcenter",function(e){
            $(".delShadow").hide();
            $(this).find(".delShadow").show();
            e.stopPropagation();
        });
        $(".publish_upimg").on("click",".del",function(){
            $(this).parents(".upimg").remove();
        });
        $("body").click(function(){
            $(".delShadow").hide();
        })

    }


    function upimglen(){
        //计算已经上传的个数，判断是否显示上传按钮
        var len = $(".publish_upimg .upimg").length;
        if(len >= 3){
            $(".publish_upimg .upbtn").hide();
        }else{
            $(".publish_upimg .upbtn").show();
        }
    }
    /**
     * 发布圈子动态
     * */
    $("#data_submit").click(function(){
        var txt = $("#data_circle_txt").val();
        var photoIds="";
        var len = $(".publish_upimg .upimg").length;
        $(".publish_upimg .upimg").each(function(i){
            if(i == len-1){
                photoIds += $(this).data("photoid");
            }else{
                photoIds += $(this).data("photoid")+",";
            }

        });

//        console.log(PORT_CONNECT+"/api/v1/circle_timeline?circle_id="+circle_id+"&author_uid="+uid+"&content="+txt+"&photo_ids="+photoIds);
//        return false;
        if(txt){
            $.ajax({
                headers: {
                    Accept: "application/json; charset=utf-8",
                    Authorization: "" + userToken
                },
                type: 'post',
                url: PORT_CONNECT+"/api/v1/circle_timeline?circle_id="+circle_id+"&author_uid="+uid+"&content="+txt+"&photo_ids="+photoIds,
                success:function(data){
                    console.log(data);
                    if(data.code == 10){
                        console.log("需要传入 circle_id");
                    }else if(data.code == 11){
                        console.log("需要传入 author_uid");
                    }else if(data.code == 12){
                        console.log("需要传入 content");
                    }else if(data.code == 13){
                        wrongTs("圈子动态不可重复发送");
                    }else if(data.code == 14){
                        wrongTs("不是圈主, 不可发动态");
                    }else{
                        history.back(-1);
//                        location.href="group.html?id="+circle_id;
                    }
                },
                error:function (e) {
                    console.log("上传失败");
                }
            })
        }else{
                wrongTs("正文不能为空");
        }
    })
</script>
</body>
</html>