<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1" />
    <title>方球</title>
    <link  rel="icon" type="image/x-icon" href="./images/favicon.ico">
    <link rel="stylesheet" href="css/base.css"/>
    <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
<div id="header" class="bb518">
    <div class="main pr">
        <a class="back" href="javascript:history.go(-1);"></a>
        <span class="tit" id="data_group_name"></span>
        <a class="share" href="javascript:;"></a>
    </div>
</div>
<div class="group_box" id="comment_box">
    <ul id="data_group_comment">
        <!--<li>-->
            <!--<div class="main">-->
                <!--<div class="top">-->
                    <!--<div class="img"><img src="images/photo.jpg" alt=""/></div>-->
                    <!--<span class="name">山清</span>-->
                    <!--<span class="time">2周前</span>-->
                <!--</div>-->
                <!--<div class="txt">请教圈主，比特币能梭哈吗？</div>-->
                <!--<div class="zans">-->
                    <!--<div class="men">-->
                        <!--<span>鸭子</span>-->
                        <!--<span>石头</span>-->
                        <!--<span>大树</span>-->
                        <!--<i>等5人</i>-->
                    <!--</div>-->
                    <!--<div class="comment"><img src="images/comment.png" alt=""/></div>-->
                    <!--<div class="zan"><img src="images/praise.png" alt=""/></div>-->
                <!--</div>-->
                <!--<div class="bot bt">-->
                    <!--<p>石头：风无想要作谁人的风吹想要为家己自由飞无想要作谁人的风吹想要为家己自由飞</p>-->
                    <!--<p>石头：风无想要作谁人的风吹想要为家己自由飞无想要作谁人的风吹想要为家己自由飞</p>-->
                <!--</div>-->
            <!--</div>-->
        <!--</li>-->
    </ul>
    <p class="loadMore">点击加载更多...</p>
</div>
<div class="comment_bot">
    <div class="main pr">
        <div class="input"><input id="data_comment_txt" type="text" placeholder="回复"/></div>
        <div class="submit" id="data_submit"></div>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script src="js/js.js"></script>
<script>
var circle_timeline = GetHrefVal("groupid");
var circle_timeline_id = GetHrefVal("id");
console.log(circle_timeline);
console.log(circle_timeline_id);
/**
 * 获取一个圈子里的一个时间线
 *
 * **/
var groupName = localStorage.getItem("circlename");
$("#data_group_name").text(groupName);
var groupId = GetHrefVal("groupid");
var id = GetHrefVal("id");

var last_id = "";
/**
 * 更新页面内容
 * 进页面更新一次
 * 点赞更新一次
 * 发表评论更新一次
 *
 * */
updateContent();
function updateContent(){
    loading(1,"");
    $.ajax({
        headers: {
            Accept: "application/json; charset=utf-8",
            Authorization: "" + userToken
        },
        url:PORT_CONNECT+"/api/v1/circle/"+groupId+"/"+id+"?uid="+uid,
        type:"post",
        success:function(data){
            loading("0","");
             console.log(data);
            var data = data["data"];
            var groupInfo = data["circle_info"];//圈子信息
            var timeLineInfo = data["info"];//时间线信息
            var comments = data["comment"];
            var likes = data["like"];

            var str = '';
            str +='<li>';
            str +='<div class="main">';
            str +='<div class="top">';
            str +='<div class="img"><img src="'+IMG_SRC+timeLineInfo["author"]["photo"].photo_url+'" alt="" onerror="this.src=\'images/photo.png\'" /></div>';
            str +='<span class="name">'+timeLineInfo["author"].nickname+'</span>';
            str +='<span class="time">'+getDateDiff(timeLineInfo.created_at)+'</span>';
            str +='</div>';
            str +='<div class="txt">'+timeLineInfo.content+'</div>';
            str +='<div class="zans">';
            str +='<div class="men">';
            for(var i = 0; i< likes.length; i++){
                var author = likes[i]["author"];
                str +='<span>'+author.nickname+'</span>';
            }
            str +='<i>等'+data.like_total+'人</i>';
            str +='</div>';
            str +='<div class="zan ml10" id="data_comment"><img src="images/comment.png" alt=""/></div>';
            str +='<div class="zan" id="data_zan"><img src="images/praise.png" alt=""/></div>';
            str +='</div>';
            str +='<div class="bot bt">';
            var len = comments.length;
            for(var i = 0; i< comments.length; i++){
                if(i == len-1){
                    last_id = comments[i].id;
                }

                str +='<p>'+comments[i]["author"].nickname+'：'+comments[i].content+'</p>';
            }
            str +='</div>';
            str +='</div>';
            str +='</li>';

            $("#data_group_comment").html(str);
        },
        error:function(err){
            loading("0","");
            console.log(err)
        }

    });
}


/**
 *  圈子时间线发评论
 *
 * */
$("#data_submit").click(function(){
    var content = $("#data_comment_txt").val();
    if(content){
        loading(1,"");
        $.ajax({
            headers: {
                Accept: "application/json; charset=utf-8",
                Authorization: "" + userToken
            },
            url:PORT_CONNECT+"/api/v1/circle_timeline/"+circle_timeline+"/comment?circle_timeline_id="+circle_timeline_id+"&uid="+uid+"&content="+content,
            type:"post",
            success:function(data){
                loading(0,"");
                console.log(data);
                if(data.code == 10){
                    console.log("需要传入 circle_timeline_id");
                }else  if(data.code == 11){
                    console.log("需要传入 author_uid");
                }else  if(data.code == 12){
                    console.log("需要传入 content");
                }else  if(data.code == 13){
                    wrongTs("评论内容相同,不可重复发送");
                }else  if(data.code == 14){
                    wrongTs("非会员不可评论圈子动态");
                }else  if(data.code == 15){
                    wrongTs("评论已达上限");
                }else{
                    console.log("评论成功！");
                    updateContent();
                }
                $("#data_comment_txt").val("");
            },
            error:function(err){
                loading(0,"");
                console.log(err);
            }
        });
    }else{

    }
});


/**
 *  赞圈子动态
 *
 * */
$("#data_group_comment").on("click","#data_zan",function(){
    $.ajax({
        headers: {
            Accept: "application/json; charset=utf-8",
            Authorization: "" + userToken
        },
        url:PORT_CONNECT+"/api/v1/circle_timeline/"+circle_timeline+"/like?circle_timeline_id="+circle_timeline_id+"&uid="+uid,
        type:"post",
        success:function(data){
            loading(0,"");
            // console.log(data);
            if(data.code == 10){
                console.log("需要传入 circle_timeline_id");
            }else  if(data.code == 11){
                console.log("需要传入 uid");
            }else  if(data.code == 12){
                wrongTs("不可重复赞圈子动态");
            }else  if(data.code == 13){
                wrongTs("非会员不可赞圈子动态");
            }else{
                console.log("赞成功！");
                updateContent();
            }
        },
        error:function(err){
            loading(0,"");
            console.log(err);
        }
    });
});



//    点击刷新更多
$(".loadMore").click(function(){
    console.log(last_id);
    loading(1,"");
    $.ajax({
        headers: {
            Accept: "application/json; charset=utf-8",
            Authorization: "" + userToken
        },
        url:PORT_CONNECT+"/api/v1/circle/"+groupId+"/"+id+"?uid="+uid+"&last_id="+last_id,
        type:"post",
        success:function(data){
            loading("0","");
            console.log(data);
            var data = data["data"];
            var comments = data["comment"];

            var str = '';
            var len = comments.length;
            for(var i = 0; i< comments.length; i++){
                if(i == len-1){
                    last_id = comments[i].id;
                }
                str +='<p>'+comments[i]["author"].nickname+'：'+comments[i].content+'</p>';
            }

            $("#data_group_comment .bot").append(str);
        },
        error:function(err){
            loading("0","");
            console.log(err)
        }

    });
})
</script>
</body>
</html>