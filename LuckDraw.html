<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1" />
    <title>任务</title>
    <link  rel="icon" type="image/x-icon" href="./images/favicon.ico">
    <link rel="stylesheet" href="css/base.css"/>
    <link rel="stylesheet" href="css/style.css"/>
    <style>
        html,body{width: 100%; height: 100%; background: #fff;}
        body{-webkit-overflow-scrolling: touch; overflow: auto;}
        .luckDrawUl::-webkit-scrollbar{width: 0; -webkit-overflow-scrolling: touch;}
    </style>
    <script>
        //    设置page,判断当前页面是否是login页面，判断未登录的情况下需不需要进入到登陆页面
        /**
         * pageState 用于判断当前页面需不需要登陆才能访问的参数
         * 0：不需要登录即可访问
         * 1：需要登录才能访问
         * */
        localStorage.setItem("pageState", "0");
    </script>
</head>
<body>
<!--
<div class="luckFixedBox"  style="display: none;">
    <div class="zpBox">
        <div class="zpWrap">
            <div class="zpCenter"><img src="images/lunbg.png" alt=""/></div>
            <div class="zpPointer"><img src="images/pointer.png" alt=""/></div>
            <img class="leave1" src="images/leave1.png" alt=""/>
            <img class="leave2"  src="images/leave2.png" alt=""/>
            <img class="leave3"  src="images/leave3.png" alt=""/>
            <img class="leave4"  src="images/leave4.png" alt=""/>
        </div>
        <div class="lpshadow"><img src="images/lpshadow.png" alt=""/></div>
        <p class="lpcs"><span>剩余抽奖次数:0</span></p>
        <div class="lpbtn"><img src="images/lpbtn.png" alt=""/></div>
        <p class="lpts"><span>每次游戏仅消耗0xball哦</span></p>
    </div>
</div>-->
<div id="coin_header" style="z-index: 21; border-bottom: 1px solid #eee;">
    <div class="main pr top">
        <a class="back" id="backToPrev" data-type="1" href="javascript:;"></a>
        <span class="tit"  id="rw_tit" >任务</span>
    </div>
</div>
<div class="LuckDrawBox" >
    <div class="LuckDrawDate"  style="display: none;">
        <h2 class="tit">明天签到可领28Xball</h2>
        <div class="luckDrawUl">
            <ul class="LuckDrawDateList oh">
                <div class="requestLoadingTs">正在请求数据...</div>
                <!--<li class="hasGet">-->
                    <!--<div class="top">-->
                        <!--<p>已领</p>-->
                        <!--<p>+15</p>-->
                    <!--</div>-->
                    <!--<p class="day">1天</p>-->
                <!--</li>-->
                <!--<li>-->
                    <!--<div class="top">-->
                        <!--<p>已领</p>-->
                        <!--<p>+15</p>-->
                    <!--</div>-->
                    <!--<p class="day">2天</p>-->
                <!--</li>-->
                <!--<li class="noStart">-->
                    <!--<div class="top">-->
                        <!--<p>已领</p>-->
                        <!--<p>+15</p>-->
                    <!--</div>-->
                    <!--<p class="day">3天</p>-->
                <!--</li>-->
                <!--<li>-->
                    <!--<div class="top">-->
                        <!--<p>已领</p>-->
                        <!--<p>+15</p>-->
                    <!--</div>-->
                    <!--<p class="day">4天</p>-->
                <!--</li>-->
                <!--<li>-->
                    <!--<div class="top">-->
                        <!--<p>已领</p>-->
                        <!--<p>+15</p>-->
                    <!--</div>-->
                    <!--<p class="day">5天</p>-->
                <!--</li>-->
                <!--<li class="noStart">-->
                    <!--<div class="top">-->
                        <!--<p>已领</p>-->
                        <!--<p>+15</p>-->
                    <!--</div>-->
                    <!--<p class="day">6天</p>-->
                <!--</li>-->
                <!--<li>-->
                    <!--<div class="top">-->
                        <!--<p>已领</p>-->
                        <!--<p>+15</p>-->
                    <!--</div>-->
                    <!--<p class="day">7天</p>-->
                <!--</li>-->
            </ul>
        </div>
    </div>
    <div class="LuckDrawBtn"  style="display: none;">
        <div class="main" ><img src="./images/rw_btn.png" alt=""/></div>
    </div>
    <div class="LuckDrawCont" style="padding-top: 41px;">
        <h2 class="tit"  style="display: none;">日常任务</h2>
        <div class="LuckDrawWorks main pr">
            <ul class="LuckDrawWorksList">
                <div class="requestLoadingTs">正在请求数据...</div>
                <!--
                <li class="task_invite">
                    <div class="top oh"><div
                            class="topcenter"><div class="name"><div class="name_txt">邀请好友邀请好友邀请好友邀请好友</div><span class="zhiding">置顶</span></div><span class="xball">+200 xball</span><span class="done"></span></div></div>
                    <div class="cont pr">
                        <div class="txt">Xball是方球对用户价值的奖励，也是一种数字资产。</div>
                        <div class="btn" onclick="pageTo(1);">去邀请</div>
                    </div>
                </li>
                <li class="task_invite">
                    <div class="top oh"><div
                            class="topcenter"><div class="name"><div class="name_txt">邀请好友邀请好友邀请好友邀请好友</div><span class="zhiding">置顶</span></div><span class="xball">+200 xball</span><span class="done"></span></div></div>
                    <div class="cont pr">
                        <div class="txt">Xball是方球对用户价值的奖励，也是一种数字资产。</div>
                        <div class="btn" onclick="pageTo(1);">去邀请</div>
                    </div>
                </li>
                <li class="task_invite">
                    <div class="top oh"><div
                            class="topcenter"><div class="name"><div class="name_txt">邀请好友邀请好友邀请好友邀请好友</div><span class="zhiding">置顶</span></div><span class="xball">+200 xball</span><span class="done"></span></div></div>
                    <div class="cont pr">
                        <div class="txt">Xball是方球对用户价值的奖励，也是一种数字资产。</div>
                        <div class="btn" onclick="pageTo(1);">去邀请</div>
                    </div>
                </li>
                <li class="task_invite">
                    <div class="top oh"><div
                            class="topcenter"><div class="name"><div class="name_txt">邀请好友邀请好友邀请好友邀请好友</div><span class="zhiding">置顶</span></div><span class="xball">+200 xball</span><span class="done"></span></div></div>
                    <div class="cont pr">
                        <div class="txt">Xball是方球对用户价值的奖励，也是一种数字资产。</div>
                        <div class="btn" onclick="pageTo(1);">去邀请</div>
                    </div>
                </li>
                <li class="task_invite">
                    <div class="top oh"><div
                            class="topcenter"><div class="name"><div class="name_txt">邀请好友邀请好友邀请好友邀请好友</div><span class="zhiding">置顶</span></div><span class="xball">+200 xball</span><span class="done"></span></div></div>
                    <div class="cont pr">
                        <div class="txt">Xball是方球对用户价值的奖励，也是一种数字资产。</div>
                        <div class="btn" onclick="pageTo(1);">去邀请</div>
                    </div>
                </li>-->
            </ul>
        </div>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script src="js/js.js"></script>
<script>
    loading("1","");
    $(".LuckDrawWorksList").on("click",".top",function(){
        var This = $(this).find(".xball");
        This.toggleClass("down").siblings().removeClass("down");
        This.parents("li").siblings().find(".xball").removeClass("down");
        if(This.hasClass("down")){
            This.parents("li").addClass("open").siblings("li").removeClass("open");
        }else{
            This.parents("li").removeClass("open");
        }
    });
    var requestState1 = 1;
    var requestState2 = 0;
    var uid = uid;
    if(!uid){
        uid = GetHrefVal("uid");
    }
    var token = GetHrefVal("token");
    if(!token){
        token = userToken;
    }
    var isml = GetHrefVal("isml");
    console.log("uid="+uid);
    console.log("token="+token);
    console.log("isml="+isml);


//    if(!uid){
//        uid = "481b676ed2c01862e1bd17c2c99e32cf";
//    }

    function loadingHide(){
        if(requestState1 == 1 && requestState2 == 1){
            loading("0","");
        }
    }

    /**
     * 签到列表信息
     *

    $.ajax({
        headers: {
            Accept: "application/json; charset=utf-8",
            Authorization: "" + token
        },
        url:PORT_CONNECT+"/api/v1/my_sign?uid="+uid,
        type:"post",
        success:function(data){
            requestState1 = 1;
            loadingHide();
            console.log("签到列表信息");
            console.log(data);

            if(data.code == 0){

                var data = data["data"];
                var str = '';
                $.each(data,function(i,v){
                    if(v.if_signed){
                        str +='<li class="hasGet" data-ts="'+ v.ts+'">';
                    }else{
                        str +='<li data-ts="'+ v.ts+'">';
                    }
                    str +='<div class="top">';
                    str +='<p>已领</p>';
                    str +='<p>+'+ v.xball+'</p>';
                    str +='</div>';
                    str +='<p class="day">'+ (v.index+1)+'天</p>';
                    str +='</li>';
                });
                $(".LuckDrawDateList").html(str);
                var zw =  $(".LuckDrawDateList li").length*($(".LuckDrawDateList li").width()+16);
                $(".LuckDrawDateList").css({"width":zw});

            }else{
                wrongTs(data.message);
            }
        },
        error:function(err){
            requestState1 = 1;
            loadingHide();

            console.log(err)
        }

    });
     * */

    //签到功能点击
    $(".LuckDrawDateList").on("click","li",function(){
        alert($(this).find(".day").text());
    });

    /**
     * APP日常任务
     *

     返回到 app                                      对应app跳转     pageToApp(666);

     "invite" 邀请 N 个好友              flag=0       对应app跳转     pageToApp(0);

     "join_circle" 加入 N 个圈子数       flag=1        对应app跳转      pageToApp(1);

     "timeline_comment" 发评论          flag=2        对应app跳转      pageToApp(2);

     "timeline_like" 表示喜欢,为圈主点赞   flag=3         对应app跳转      pageToApp(3);

     "news_useful" 表示资讯有用          flag=4         对应app跳转      pageToApp(4);

     "news_nouseful" 表示资讯无用        flag=5         对应app跳转      pageToApp(5);

     "coin_up" 对币资讯看好              flag=6         对应app跳转      pageToApp(6);

     "coin_down" 对币资讯看空            flag=7         对应app跳转      pageToApp(7);

     "activity_interest" 对活动感兴趣    flag=8         对应app跳转      pageToApp(8);

     "create_circle" 创建圈子           flag=9         对应app跳转      pageToApp(9);
     * */

    $.ajax({
        headers: {
            Accept: "application/json; charset=utf-8",
            Authorization: "" + token
        },
        url:PORT_CONNECT+"/api/v1/task?uid="+uid,
        type:"post",
        success:function(data){
            requestState2 = 1;
            loadingHide();
            loading("0","");
            console.log("获取APP日常任务");
            console.log(data);
            if(data.code == 0){

                var data = data["data"];
                var str = '';
                $.each(data,function(i,v){
                    str += '<li class="task_invite">';
                    str += '<div class="top oh">';
                    str += '<div class="topcenter">';

                    str += '<div class="name"><div class="name_txt">'+v.title+'</div><span class="zhiding">'+ v.complete+'/'+ v.target+'</span></div>';
    //                str += '<span class="zhiding ">置顶</span>';
                    //str += '<span class="zhiding ">'+ v.complete+'/'+ v.target+'</span>';
                    str += '<span class="xball">+'+ v.xball+' xball</span>';
                    if(v.is_complete){
                        str += '<span class="done"></span>';
                    }
                    str += '</div>';
                    str += '</div>';
                    str += '<div class="cont pr">';
                    str += '<div class="txt">'+ v.msg+'</div>';
                    str += '<div class="btn" onclick="pageTo('+ v.flag+');">'+ v.btn+'</div>';
                    str += '</div>';
                    str += '</li>';
                });
                $(".LuckDrawWorksList").html(str);

            }else{
                wrongTs(data.message);
            }
        },
        error:function(err){
            requestState2 = 1;
            loadingHide();
            loading("0","");
            console.log(err)
        }

    });
    /**
     * app给H5传递参数形式
     * "../LuckDraw.html?uid=481b676ed2c01862e1bd17c2c99e32cf&token=23456&isml=1";
     * uid：用户id
     * token:token
     * isml:判断是不是app传递过来的;如果是1表示是网页跳转过来的，如果为false表示是app跳转过来的
     *
     * app:判断是不是由app跳转进来的
     * 1 是app跳转进来的
     * 0 是网页跳转进来的
     *
     * page:参数代表要跳转的页面
     * 0:返回app
     * 1：邀请好友
     * 2：加入圈子
     * 3：发布动态
     * 4：发评论
     *
     *isAndroid：判断是不是Android终端 true 是
     *isiOS：判断是不是isiOS终端 true 是
     * javaKey:和Android商定的关键字
     * */

    //  定义命名空间 LenSmJs
    //the judgment is ios or Android？
    var LenSmJsU = navigator.userAgent;
    var isAndroid = LenSmJsU.indexOf('Android') > -1 || LenSmJsU.indexOf('Adr') > -1; //android终端
    var isiOS = !!LenSmJsU.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
    function pageTo(page){
        console.log("page="+page);
        if(isml == 1){
            //网页端
            if(page == 1){
                location.href = "";
            }else if(page == 2){
                location.href = "";
            }else if(page == 3){
                location.href = "";
            }else if(page == 4){
                location.href = "";
            }else if(page == 5){
                location.href = "";
            }else if(page == 6){
                location.href = "";
            }else if(page == 7){
                location.href = "";
            }else if(page == 8){
                location.href = "";
            }
        }else{
            //app
            if(isAndroid == true){
                //android终端
                javaKey.PageToAPP(page);
            }else{
                //ios终端
                //PageToAPP(page);
                window.webkit.messageHandlers.PageToAPP.postMessage(page);
            }
        }
    }
</script>
<script>
    //抽奖页面

    var winW = $(window).width();
    luckHide();
    function luckHide(){
        $("body").removeClass("oh");
        $(".luckFixedBox").css("left",winW);
        //$("#rw_tit").text("任务");
        $("#backToPrev").data("type",1);
        setTimeout(function(){
            $(".luckFixedBox").show();
        },300);
    }
    function luckShow(){
        //$("#rw_tit").text("幸运大抽奖");
        $("#backToPrev").data("type",2);
        $(".luckFixedBox").css("left",0);
        $("body").addClass("oh");
    }

    $(".LuckDrawBtn").click(function(){
        luckShow();
    });
    $("#backToTask").click(function(){
        luckHide();
    });
    $("#backToPrev").click(function(){
        var t = $(this).data("type");
        var page = "666";
        if(t == 1){
            //返回app
            if(isAndroid == true){
                //android终端
                javaKey.PageToAPP(page);
            }else{
                //ios终端
                //PageToAPP(page);
                window.webkit.messageHandlers.PageToAPP.postMessage(page);
            }
        }else{
            luckHide();
        }
    });

    /**
     * 抽奖
     * 注意:图片奖品顺序，prizes奖品顺序，prizePercent奖品获奖率，以及rnum获取数一定要搞清楚，对照清楚
     *
     * */

    /**
     * 自制幸运大转盘
     * prizes:区域所对应奖品，顺时针从初始位置开始
     * prizePercent：中奖概率分布
     * yangle：要转动的角度
     * pLen:奖品种类
     * nc:每次要转动的整圈数；
     * tdeg:到达奖品位置要从初始点走的距离；
     * porder:奖品的序号
     * psite:转动后所要到达的位置 1-7对应所到区域
     * 初始位置为0deg;顺时针旋转;
     * 每次转到距离是 所要转动的圈数(nc*360+ideg/2),保证转到所要到达奖品位置的中心
     * prtxt:奖品对应提示语
     *
     * */
    //每个奖品所占度数
    var luckNum = 1; //抽奖次数
    var pLen = 7;
    var ideg = parseInt(360/pLen);
    var porder = 0;
    console.log("每一模块所占度数="+ideg);
    var nc = 10;
    var currdeg = 0; //当前所处的转动位置,每次转动后都要记录一下

    $(".lpbtn").click(function(){
        if(luckNum != 0){
            //去抽奖
            goLuckDraw();
        }else{
            wrongTs("没有抽奖次数了哟！");
        }
    });


    function goLuckDraw(){
        //获取中奖数字和提示文字去抽奖
        $.ajax({
            headers: {
                Accept: "application/json; charset=utf-8",
                Authorization: "" + token
            },
            url:PORT_CONNECT+"/api/v1/bid_award?uid="+uid,
            type:"post",
            success:function(data){
                console.log("获取中奖项和提示语");
                console.log(data);
                /**
                 array('id'=>1,'prize'=>'再接再厉','v'=>50,'msg'=>'木有中～再试一次也许会有？'),
                 array('id'=>2,'prize'=>'50Xball','v'=>47,'msg'=>'获得了50Xball哦！手气来了～'),
                 array('id'=>3,'prize'=>'1%锁定转激活额度','v'=>2,'msg'=>'中奖喽！您1%的锁定Xball会激活哦'),
                 array('id'=>4,'prize'=>'2%锁定转激活额度','v'=>1,'msg'=>'中奖喽！您2%的锁定Xball会激活哦'),
                 *
                 * */
                if(data.code == 0){
                    var data = data["data"];
                    var porder = 0;
                    if(data.id == 1){
                        porder = 5;
                    }else if(data.id == 2){
                        porder = 3;
                    }else if(data.id == 3){
                        porder = 4;
                    }else if(data.id == 4){
                        porder = 6;
                    }
                    var tstxt = data.msg;

                    console.log("对应奖品序号="+porder);
                    var tdeg = ideg * porder-ideg/2;
                    console.log("所要多转动区域="+tdeg);

                    var yangle = currdeg+(nc*360+tdeg);

                    currdeg = yangle -tdeg; //存储 下次开始时的位置（也就是之前走过的总距离-多走出的tdeg的距离，也就是让指针从零开始计算，方便循环的计算）
                    console.log("下次开始的位置="+currdeg);

                    $(".zpPointer").css("transform","rotate("+yangle+"deg)");
                    console.log("对应奖品提示文字="+tstxt);
                    setTimeout(function(){
                        wrongTs(tstxt);
                    },3000);

                }else{
                    wrongTs(data.message);
                }

            },
            error:function(err){
                console.log(err)
            }

        });


    }
</script>
<script>
    //js抛出异常
    window.onerror = function(msg, url, line, col, error) {
        // Note that col & error are new to the HTML 5 spec and may not be
        // supported in every browser.  It worked for me in Chrome.
        var extra = !col ? '' : '\ncolumn: ' + col;
        extra += !error ? '' : '\nerror: ' + error;

        // You can view the information in an alert to see things working like this:
        LenSmJs.h5log("JsError: " + msg + "\nurl: " + url + "\nline: " + line + extra);

        // TODO: Report this error via ajax so you can keep track
        //       of what pages have JS issues

        var suppressErrorAlert = true;
        // If you return true, then error alerts (like in older versions of
        // Internet Explorer) will be suppressed.
        return suppressErrorAlert;
    };
</script>
</body>
</html>