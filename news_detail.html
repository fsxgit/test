<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1" />
    <title>方球</title>
    <link  rel="icon" type="image/x-icon" href="./images/favicon.ico">
    <link rel="stylesheet" href="css/base.css"/>
    <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
<div id="header" class="bb518">
    <div class="main pr top">
        <a class="back" href="javascript:history.go(-1);"></a>
        方球
    </div>
</div>
<div class="news_detail_box">
    <div class="news_detail_top">
        <div class="main tc">
            <h3 class="tit" id="data_news_tit"></h3>
            <div class="author"><img id="data_news_authorimg" src="images/photo.png" onerror="this.src='images/photo.png'"  alt=""/><span class="author_name" id="data_news_author"></span><span class="author_time" id="data_news_time"></span></div>
        </div>
    </div>
    <div class="news_detail_cont">
        <div class="main" id="data_news_content">
            <!--<p>李礼辉也介绍说，中国互联网金融协会在2018年的工作重点之一就是要积极推进标准化建设，“区块链要有一个新的技术标准体系，特别是还要建立一个权威的第三方认证的系统，这是区块链金融发展的当务之急”。</p> <p>标准的确立也会与监管之间发生千丝万缕的联系，虽然从目前来看，监管层对区块链相当关注，但主要是集中于金融领域，特别是去年下半年对虚拟货币和ICO(首次币发行)采取了严控措施。在中国人民大学大数据区块链与监管科技实验室主任杨东看来，从区块链整个行业的发展来看，法律和监管仍然相对滞后。与海外先进国家相比较，缺乏对区块链进行定义并管理其交易和交易平台的专门法律。“那么就需要行业自律，行业上下游大家坐在一起把标准和规则搞出来，才知道要怎么监管。在区块链标准方面，中国要主导、掌握和参与标准制定。‘游戏规则’需要各方共建，大家共同努力。”杨东说。</p>-->

        </div>
    </div>
    <div class="new_detail_praise">
        <div class="main">
            <div class="praise_top pr">
                <span class="praise" id="data_praise">有用(3)</span>
                <span class="reject" id="data_reject">(2)没用</span>
                <div class="praise_progress pr"><span class="praise_percent" id="data_percent" style="width: 60%;"></span></div>
            </div>
        </div>
    </div>
    <div class="activity_detail_comment">
        <ul id="data_news_comment">
            <!--<li>-->
                <!--<div class="img"><img src="images/photo.jpg" alt=""/></div>-->
                <!--<div class="right_box">-->
                    <!--<p class="comment_name">旺达</p>-->
                    <!--<p class="comment_time">2周前</p>-->
                    <!--<p class="comment_txt">有没有媒体圈子？我需要欢迎大家推荐有没有媒体圈子？我需要欢迎大家推荐有没有媒体圈子？我需要欢迎大家推荐有没有媒体圈子？我需要欢迎大家推荐</p>-->
                <!--</div>-->
            <!--</li>-->
        </ul>
    </div>
    <p class="loadMore">点击加载更多...</p>
</div>
<div class="comment_bot">
    <div class="main pr">
        <div class="input"><input type="text" id="data_txt" placeholder="回复"/></div>
        <div class="submit" id="data_submit"></div>
    </div>
</div>
<script src="js/jquery.min.js"></script>
<script src="js/js.js"></script>
<script>
var last_id = "";

/**
 * 赞成与反对的占比计算
 * Y:赞成数目
 * N:反对数目
 * */
var Y = 0;
var N = 0;
function praisePercent(Y,N){
    $("#data_praise").text("有用("+Y+")");
    $("#data_reject").text("("+N+")没用");
    var w = 1;
    if(N == Y){
        w = 0.5;
    }else{
        if(Y == 0){
            w = 0;
        }else if(N == 0){
            w = 1;
        }else{
            w = Y/(Y+N);
        }
    }
    $("#data_percent").css("width",w*100+"%");
}



/**
 * 获取单个资讯
 *
 * */
var id = GetHrefVal("id");
var entity_type = "";
commentLoad("0","");
function commentLoad(state,lastId){
    loading(1,"");
    var URL = "";
    if(state == 0){
        URL = PORT_CONNECT+"/api/v1/news/"+id;
    }else{
        URL = PORT_CONNECT+"/api/v1/news/"+id+"&last_id="+lastId;
    }
    $.ajax({
        headers: {
            Accept: "application/json; charset=utf-8",
            Authorization: "" + userToken
        },
        url:URL,
        type:"post",
        success:function(data){
            loading(0,"");
            console.log(data);
            if(data.code == 10){
                alert("新闻未找到");
            }else{
                var data = data["data"];
                var NewsComments = data["comment"]; //新闻评论
                if(state == 0){

                    var NewsInfo = data["info"]; //新闻信息
                    var NewsContent = data["content"]; //新闻内容

                    $("#data_news_tit").text(NewsInfo.title);
                    $("#data_news_author").text(NewsInfo["author"].nickname);
                    $("#data_news_authorimg").attr("src",IMG_SRC + NewsInfo["photo"].photo_url);
                    $("#data_news_time").text(getDateDiff(NewsInfo.created_at));
                    entity_type = NewsContent[0].entity_type;

                    // 赞成与反对占比计算
                    Y = data.trend_yes;
                    N = data.trend_no;
                    praisePercent(Y,N);


                    // 新闻内容
                    var strContent="";
                    $.each(NewsContent,function(i,v){
                        strContent += v.content;
                    });
                    $("#data_news_content").html(strContent);
                }

                // 新闻评论
                var strComment="";
                var len = NewsComments.length;
                $.each(NewsComments,function(i,v){
                    if(i == len-1){
                        last_id = v.id;
                    }
                    strComment +='<li>';
                    strComment +='<div class="img"><img src="'+IMG_SRC+v["author"]["photo"].photo_url+'" alt="" onerror="this.src=\'images/photo.png\'" /></div>';
                    strComment +='<div class="right_box">';
                    strComment +='<p class="comment_name">'+v["author"].nickname+'</p>';
                    strComment +='<p class="comment_time">'+getDateDiff(v.created_at)+'</p>';
                    strComment +='<p class="comment_txt">'+v.content+'</p>';
                    strComment +='</div>';
                    strComment +='</li>';
                });
                if(state == 0){
                    $("#data_news_comment").html(strComment);
                }else{
                    $("#data_news_comment").append(strComment);
                }
            }
        },
        error:function(err){
            loading(0,"");
            console.log(err);
        }

    });
}


/**
 *  对资讯利好或利空[赞成，反对]
 * yes_or_no - 1利好 2利空
 * */
$("#data_praise").click(function(){
    loading(1,"");
    $.ajax({
        headers: {
            Accept: "application/json; charset=utf-8",
            Authorization: "" + userToken
        },
        url:PORT_CONNECT+"/api/v1/news_trend?news_id="+id+"&uid="+uid+"&yes_or_no="+1,
        type:"post",
        success:function(data){
            loading(0,"");
            // console.log(data);
            if(data.code == 10){
                console.log("需要传入news_id");
            }else  if(data.code == 11){
                console.log("需要传入 uid");
            }else  if(data.code == 12){
                console.log("需要传入yes_or_no");
            }else  if(data.code == 13){
                //console.log("您已经对资讯发表态度");
                wrongTs("您已经对资讯发表态度");
            }else if(data.code == 401){
                wrongTs("未授权");
            }else{
                // 赞成与反对占比计算
                Y = Y+1;
                praisePercent(Y,N);
            }
        },
        error:function(err){
            loading(0,"");
            console.log(err);
        }
    });

});
$("#data_reject").click(function(){
    loading(1,"");
    $.ajax({
        headers: {
            Accept: "application/json; charset=utf-8",
            Authorization: "" + userToken
        },
        url:PORT_CONNECT+"/api/v1/news_trend?news_id="+id+"&uid="+uid+"&yes_or_no="+2,
        type:"post",
        success:function(data){
            loading(0,"");
            // console.log(data);
            if(data.code == 10){
                console.log("需要传入news_id");
            }else  if(data.code == 11){
                console.log("需要传入 uid");
            }else  if(data.code == 12){
                console.log("需要传入yes_or_no");
            }else  if(data.code == 13){
                //console.log("您已经对资讯发表态度");
                wrongTs("您已经对资讯发表态度");
            }else{
                N = N+1;
                praisePercent(Y,N);
            }
        },
        error:function(err){
            loading(0,"");
            console.log(err);
        }

    });
});


/**
 * 对资讯进行评论
 *
 * */

$("#data_submit").click(function(){
    var content = $("#data_txt").val();
    if(content){
        loading(1,"");
        $.ajax({
            headers: {
                Accept: "application/json; charset=utf-8",
                Authorization: "" + userToken
            },
            url:PORT_CONNECT+"/api/v1/comment/"+id,
            data:{
                entity_type: entity_type,
                nid: id,
                uid: uid,
                content: content
            },
            type:"post",
            success:function(data){
                loading(0,"");
                // console.log(data);
                if(data.code == 10){

                }else if(data.code == 11){
                    console.log("需要传入 entity_type");
                }else if(data.code == 14){
                    console.log("不能发送重复评论");
                }else if(data.code == 15){
                    wrongTs("已达上限");
                }else{
                    // 评价之后局部刷新[只刷新评价的内容]
                    window.location.reload();
                }
            },
            error:function(err){
                loading(0,"");
                console.log(err);
            }

        });
    }else{
        wrongTs("内容不能为空");
    }
});

//    点击刷新更多
$(".loadMore").click(function(){
    console.log(last_id);
    commentLoad("1",last_id);
})
</script>
</body>
</html>